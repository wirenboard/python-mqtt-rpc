#!/usr/bin/env python3

import argparse
import json
import pprint

from jsonrpc.exceptions import JSONRPCError
from mqttrpc.client import MQTTRPCError, TimeoutError, TMQTTRPCClient
from wb_common.mqtt_client import MQTTClient


def main():
    parser = argparse.ArgumentParser(description="Sample RPC client", add_help=False)
    parser.add_argument(
        "-b",
        "--broker",
        dest="broker_url",
        type=str,
        help="MQTT broker url",
        default="unix:///var/run/mosquitto/mosquitto.sock",
    )
    parser.add_argument("-d", "--driver", dest="driver", type=str, help="Driver name")
    parser.add_argument("-s", "--service", dest="service", type=str, help="Service name")
    parser.add_argument("-m", "--method", dest="method", type=str, help="Method name")
    parser.add_argument("-a", "--args", dest="args", type=json.loads, help="Method arguments")
    parser.add_argument("-t", "--timeout", dest="timeout", type=int, help="Timeout in seconds", default=10)
    args = parser.parse_args()

    try:
        mqtt_client = MQTTClient("mqtt-rpc-client", args.broker_url)
        rpc_client = TMQTTRPCClient(mqtt_client)
        mqtt_client.on_message = rpc_client.on_mqtt_message
        mqtt_client.connect()

        resp = rpc_client.call(args.driver, args.service, args.method, args.args, args.timeout)
        pprint.pprint(resp)
    except TimeoutError:
        print("Request timed out")
    except Exception as e:
        print("Error: %s" % e)


if __name__ == "__main__":
    main()
